{%- set tnpolns = namespace(policies={}) -%}

{#- tenant.policies.bfd_interface_policies -#}
{%- set bfdintpol = namespace(bfd_interface_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bfdIfPol', 'defined')
  | map(attribute='bfdIfPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bfdintpol.bfd_interface_policies = bfdintpol.bfd_interface_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'subinterface_optimization': 'true' if 'opt-subif' in pol.attributes.ctrl
      else '' | default(''),
    'detection_multiplier': pol.attributes.detectMult | default('')
      | regex_replace('^3$', ''),
    'echo_admin_state': 'false' if pol.attributes.echoAdminSt == 'disabled'
      else '' | default(''),
    'echo_rx_interval': pol.attributes.echoRxIntvl | default('')
      | regex_replace('^50$', ''),
    'min_rx_interval': pol.attributes.minRxIntvl | default('')
      | regex_replace('^50$', ''),
    'min_tx_interval': pol.attributes.minTxIntvl | default('')
      | regex_replace('^50$', ''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bfd_interface_policies',
  bfdintpol.bfd_interface_policies) -%}

{#- tenant.policies.bfd_multihop_node_policies -#}
{%- set bfdmhpol = namespace(bfd_multihop_node_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bfdMhNodePol', 'defined')
  | map(attribute='bfdMhNodePol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bfdmhpol.bfd_multihop_node_policies = bfdmhpol.bfd_multihop_node_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'detection_multiplier': pol.attributes.detectMult | default('')
      | regex_replace('^3$', ''),
    'min_rx_interval': pol.attributes.minRxIntvl | default('')
      | regex_replace('^250$', ''),
    'min_tx_interval': pol.attributes.minTxIntvl | default('')
      | regex_replace('^250$', ''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bfd_multihop_node_policies',
  bfdmhpol.bfd_multihop_node_policies) -%}

{#- tenant.policies.bgp_address_family_context_policies -#}
{%- set bgpctxpol = namespace(bgp_address_family_context_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bgpCtxAfPol', 'defined')
  | map(attribute='bgpCtxAfPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bgpctxpol.bgp_address_family_context_policies =
    bgpctxpol.bgp_address_family_context_policies + [{
      'name': pol.attributes.name,
      'description': pol.attributes.descr | default(''),
      'ebgp_distance': pol.attributes.eDist | default('') 
        | regex_replace('^20$', ''),
      'ibgp_distance': pol.attributes.iDist | default('') 
        | regex_replace('^200$', ''),
      'local_distance': pol.attributes.localDist | default('') 
        | regex_replace('^220$', ''),
      'ebgp_max_ecmp': pol.attributes.maxEcmp | default('') 
        | regex_replace('^16$', ''),
      'ibgp_max_ecmp': pol.attributes.maxEcmpIbgp | default('') 
        | regex_replace('^16$', ''),
      'local_max_ecmp': pol.attributes.maxLocalEcmp | default(''),
      'enable_host_route_leak': 'true' if 'host-rt-leak' in pol.attributes.ctrl
        else '' | default(''),
    }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bgp_address_family_context_policies',
  bgpctxpol.bgp_address_family_context_policies) -%}

{#- tenant.policies.bgp_best_path_policies -#}
{%- set bgpbestp = namespace(bgp_best_path_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bgpBestPathCtrlPol', 'defined')
  | map(attribute='bgpBestPathCtrlPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bgpbestp.bgp_best_path_policies = bgpbestp.bgp_best_path_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'as_path_multipath_relax': 'true' if 'asPathMultipathRelax' in pol.attributes.ctrl
      else '' | default(''),
    'ignore_igp_metric': 'true' if 'ignoreIgpMetric' in pol.attributes.ctrl
      else '' | default(''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bgp_best_path_policies', bgpbestp.bgp_best_path_policies) -%}

{#- tenant.policies.bfd_multihop_node_policies -#}
{%- set bgppfxpol = namespace(bgp_peer_prefix_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bfdMhNodePol', 'defined')
  | map(attribute='bfdMhNodePol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bgppfxpol.bgp_peer_prefix_policies = bgppfxpol.bgp_peer_prefix_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'acion': pol.attributes.action | default('') | replace('reject', ''),
    'max_prefixes': pol.attributes.maxPfx | default('')
      | regex_replace('^20000$', ''),
    'threshold': pol.attributes.thresh | default('')
      | regex_replace('^75$', ''),
    'restart_time': pol.attributes.restartTie | default('')
      | regex_replace('^65534$', ''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bgp_peer_prefix_policies', bgppfxpol.bgp_peer_prefix_policies) -%}

{#- tenant.policies.bgp_route_summarization_policies -#}
{%- set bfdintpol = namespace(bgp_route_summarization_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bgpRtSummPol', 'defined')
  | map(attribute='bgpRtSummPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bfdintpol.bgp_route_summarization_policies = bfdintpol.bgp_route_summarization_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'as_set': 'true' if 'as-set' in pol.attributes.ctrl
      else '' | default(''),
    'summary_only': 'true' if 'summary-only' in pol.attributes.ctrl
      else '' | default(''),
    'af_mcast': 'true' if 'af-mcast' in pol.attributes.ctrl
      else '' | default(''),
    'af_ucast': 'false' if 'af-ucast' not in pol.attributes.ctrl
      else '' | default(''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bgp_route_summarization_policies', bfdintpol.bgp_route_summarization_policies) -%}

{#- tenant.policies.bgp_timer_policies -#}
{%- set bpgtimerpol = namespace(bgp_timer_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bgpCtxPol', 'defined')
  | map(attribute='bgpCtxPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bpgtimerpol.bgp_timer_policies = bpgtimerpol.bgp_timer_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'keepalive_interval': pol.attributes.kaIntvl | default('')
      | regex_replace('^60$', ''),
    'hold_interval': pol.attributes.holdIntvl | default('')
      | regex_replace('^180$', ''),
    'stale_interval': pol.attributes.staleIntvl | default('')
      | regex_replace('^replace$', ''),
    'graceful_restart_helper': 'false' if 'helper' in pol.attributes.descr
      else '' | default(''),
    'maximum_as_limit': pol.attributes.maxAsLimit | default('')
      | regex_replace('^0$', ''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bgp_timer_policies', bpgtimerpol.bgp_timer_policies) -%}

{#- tenant.policies.dhcp_option_policies -#}
{%- set dhcpoptpol = namespace(dhcp_option_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('dhcpOptionPol', 'defined')
  | map(attribute='dhcpOptionPol') | default('')
  | sort(attribute='attributes.name') %}
  {%- set optsns = namespace(options=[]) -%}
  {% for opt in [pol] | selectattr('children', 'defined')
    | map(attribute='children') | flatten
    | selectattr('dhcpOption', 'defined') | map(attribute='dhcpOption')
    | default('') | sort(attribute='attributes.name') %}
    {% set optsns.options = optsns.options + [{
      'name': opt.attributes.name,
      'description': opt.attributes.descr | default(''),
      'id': opt.attributes.id | default(''),
      'data': opt.attributes.data | default(''),
    }] %}
  {% endfor %}
  {% set dhcpoptpol.dhcp_option_policies = dhcpoptpol.dhcp_option_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'options': optsns.options,
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('dhcp_option_policies', dhcpoptpol.dhcp_option_policies) -%}

{#- tenant.policies.dhcp_relay_policies -#}
{%- set dhcprelpol = namespace(dhcp_relay_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('dhcpRelayP', 'defined')
  | map(attribute='dhcpRelayP') | default('')
  | sort(attribute='attributes.name') %}
  {%- set provns = namespace(providers=[]) -%}
  {% for prov in [pol] | selectattr('children', 'defined')
    | map(attribute='children') | flatten
    | selectattr('dhcpRsProv', 'defined') | map(attribute='dhcpRsProv')
    | default('') | sort(attribute='attributes.name') %}
    {% set provns.providers = provns.providers + [{
      'ip': prov.attributes.addr,
      'type': 'external_epg' if '/out-' in prov.attributes.tDn else 'epg',
      'tenant': prov.attributes.tDn
        | regex_replace('uni\/tn-(.*?)\/(?:out-|ap-)(.*?)\/(?:instP-|epg-)(.*?)$', '\\1'),
      'application_profile': prov.attributes.tDn
        | regex_replace('uni\/tn-(.*?)\/(?:out-|ap-)(.*?)\/(?:instP-|epg-)(.*?)$', '\\2')
        if '/ap-' in prov.attributes.tDn else '' | default(''),
      'l3out': prov.attributes.tDn
        | regex_replace('uni\/tn-(.*?)\/(?:out-|ap-)(.*?)\/(?:instP-|epg-)(.*?)$', '\\2')
        if '/out-' in prov.attributes.tDn else '' | default(''),
      'endpoint_group': prov.attributes.tDn
        | regex_replace('uni\/tn-(.*?)\/(?:out-|ap-)(.*?)\/(?:instP-|epg-)(.*?)$', '\\3')
        if '/ap-' in prov.attributes.tDn else '' | default(''),
      'external_endpoint_group': prov.attributes.tDn
        | regex_replace('uni\/tn-(.*?)\/(?:out-|ap-)(.*?)\/(?:instP-|epg-)(.*?)$', '\\3')
        if '/out-' in prov.attributes.tDn else '' | default(''),
    }] %}
  {% endfor %}
  {% set dhcprelpol.dhcp_relay_policies = dhcprelpol.dhcp_relay_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'providers': provns.providers,
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('dhcp_relay_policies', dhcprelpol.dhcp_relay_policies) -%}

{#- tenant.policies.eigrp_interface_policies -#}
{%- set eirgpintpol = namespace(eigrp_interface_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bfdIfPol', 'defined')
  | map(attribute='bfdIfPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set eirgpintpol.eigrp_interface_policies = eirgpintpol.eigrp_interface_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
    'passive_interface': 'true' if 'passive' in pol.attributes.ctrl
      else '' | default(''),
    'split_horizon': 'false' if 'split-horizon' in pol.attributes.ctrl
      else '' | default(''),
    'self_nexthop': 'false' if 'nh-self' in pol.attributes.ctrl
      else '' | default(''),
    'bfd': 'true' if 'bfd' in pol.attributes.ctrl
      else '' | default(''),
    'hello_interval': pol.attributes.helloIntvl | default('')
      | regex_replace('^5$', ''),
    'hold_interval': pol.attributes.holdIntvl | default('')
      | regex_replace('^15$', ''),
    'bandwidth': pol.attributes.bw | default('')
      | regex_replace('^0$', ''),
    'delay': pol.attributes.delay | default('')
      | regex_replace('^0$', ''),
    'delay_unit': pol.attributes.delayUnit | default('')
      | regex_replace('^tens-of-micro$', '')
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('eigrp_interface_policies', eirgpintpol.eigrp_interface_policies) -%}

{#- tenant.policies.endpoint_ip_tags -#}
{%- set epiptagpol = namespace(endpoint_ip_tags=[]) -%}
{% for pol in this_tenant.children | selectattr('fvEpTags', 'defined')
  | map(attribute='fvEpTags')
  | selectattr('children', 'defined') | map(attribute='children') | flatten
  | selectattr('fvEpIpTag', 'defined') | map(attribute='fvEpIpTag')
  | default('') | sort(attribute='attributes.ip') %}
  {%- set tagsns = namespace(tags=[]) -%}
  {% for tag in [pol] | selectattr('children', 'defined') 
    | map(attribute='children') | flatten
    | selectattr('tagTag', 'defined') | map(attribute='tagTag')
    | sort(attribute='attributes.key') %}
    {% set tagsns.tags = tagsns.tags + [{
      'key': tag.attributes.key,
      'value': tag.attributes.value,
    }] %}
  {% endfor %}
  {% set epiptagpol.endpoint_ip_tags = epiptagpol.endpoint_ip_tags + [{
    'ip': pol.attributes.ip,
    'vrf': pol.attributes.ctxName | default(''),
    'tags': tagsns.tags | default(''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('endpoint_ip_tags', epiptagpol.endpoint_ip_tags) -%}

{#- tenant.policies.endpoint_mac_tags -#}
{%- set epmactagpol = namespace(endpoint_mac_tags=[]) -%}
{% for pol in this_tenant.children | selectattr('fvEpTags', 'defined')
  | map(attribute='fvEpTags')
  | selectattr('children', 'defined') | map(attribute='children') | flatten
  | selectattr('fvEpMacTag', 'defined') | map(attribute='fvEpMacTag')
  | default('') | sort(attribute='attributes.ip') %}
  {%- set tagsns = namespace(tags=[]) -%}
  {% for tag in [pol] | selectattr('children', 'defined') 
    | map(attribute='children') | flatten
    | selectattr('tagTag', 'defined') | map(attribute='tagTag')
    | sort(attribute='attributes.key') %}
    {% set tagsns.tags = tagsns.tags + [{
      'key': tag.attributes.key,
      'value': tag.attributes.value,
    }] %}
  {% endfor %}
  {% set epmactagpol.endpoint_mac_tags = epmactagpol.endpoint_mac_tags + [{
    'mac': pol.attributes.mac,
    'bridge_domain': pol.attributes.bdName | default('')
      | regex_replace('^\*$', 'all'),
    'vrf': pol.attributes.ctxName | default(''),
    'tags': tagsns.tags | default(''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('endpoint_mac_tags', epmactagpol.endpoint_mac_tags) -%}



{# {%- set bfdintpol = namespace(bfd_interface_policies=[]) -%}
{% for pol in this_tenant.children | selectattr('bfdIfPol', 'defined')
  | map(attribute='bfdIfPol') | default('')
  | sort(attribute='attributes.name') %}
  {% set bfdintpol.bfd_interface_policies = bfdintpol.bfd_interface_policies + [{
    'name': pol.attributes.name,
    'description': pol.attributes.descr | default(''),
  }] %}
{% endfor %}
{%- set _ = tnpolns.policies.__setitem__('bfd_interface_policies', bfdintpol.bfd_interface_policies) -%} #}

{#- tenant.policies.endpoint_retention_policies -#}
{#- tenant.policies.igmp_interface_policies -#}
{#- tenant.policies.igmp_snooping_policies -#}
{#- tenant.policies.ip_sla_policies -#}
{#- tenant.policies.match_rules -#}
{#- tenant.policies.mpls_custom_qos_policies -#}
{#- tenant.policies.multicast_route_maps -#}
{#- tenant.policies.nd_interface_policies -#}
{#- tenant.policies.nd_ra_prefix_policies -#}
{#- tenant.policies.ospf_interface_policies -#}
{#- tenant.policies.ospf_timer_policies -#}
{#- tenant.policies.pim_policies -#}
{#- tenant.policies.qos -#}
{#- tenant.policies.route_control_route_maps -#}
{#- tenant.policies.route_tag_policies -#}
{#- tenant.policies.set_rules -#}
{#- tenant.policies.span -#}
{#- tenant.policies.track_lists -#}
{#- tenant.policies.track_members -#}
{#- tenant.policies.trust_control_policies -#}
{#- tenant.policies.trust_control_policies -#}

{%- set _=tenantns.tenant_policies.__setitem__('policies', tnpolns.policies ) %}